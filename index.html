<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculation Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .pulse-correct {
            animation: pulseGreen 0.6s ease-in-out;
        }

        .pulse-incorrect {
            animation: pulseRed 0.6s ease-in-out;
        }

        @keyframes pulseGreen {
            0% {
                background-color: rgb(34, 197, 94);
                transform: scale(1);
            }

            50% {
                background-color: rgb(22, 163, 74);
                transform: scale(1.05);
            }

            100% {
                background-color: rgb(34, 197, 94);
                transform: scale(1);
            }
        }

        @keyframes pulseRed {
            0% {
                background-color: rgb(239, 68, 68);
                transform: scale(1);
            }

            50% {
                background-color: rgb(220, 38, 38);
                transform: scale(1.05);
            }

            100% {
                background-color: rgb(239, 68, 68);
                transform: scale(1);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body
    class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 min-h-screen transition-colors duration-300">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <!-- Header -->
        <div class="text-center mb-8 relative">
            <button onclick="toggleSettings()"
                class="absolute top-0 right-0 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 p-2 rounded-lg shadow-md transition-colors duration-200">
                ‚öôÔ∏è
            </button>
            <h1 class="text-4xl font-bold text-gray-800 dark:text-white mb-2">üßÆ Calculation Game</h1>
            <p class="text-gray-600 dark:text-gray-300">Test your math skills and beat your high score!</p>
        </div>

        <!-- Settings Panel -->
        <div id="settingsPanel"
            class="hidden bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6 border dark:border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white">‚öôÔ∏è Settings</h3>
                <button onclick="toggleSettings()"
                    class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-xl">‚úï</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Theme Settings -->
                <div class="space-y-4">
                    <h4 class="font-medium text-gray-700 dark:text-gray-300">üé® Theme</h4>
                    <div class="space-y-2">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="radio" name="theme" value="light" class="text-blue-600"
                                onchange="setTheme('light')">
                            <span class="text-gray-700 dark:text-gray-300">‚òÄÔ∏è Light Mode</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="radio" name="theme" value="dark" class="text-blue-600"
                                onchange="setTheme('dark')">
                            <span class="text-gray-700 dark:text-gray-300">üåô Dark Mode</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="radio" name="theme" value="auto" class="text-blue-600"
                                onchange="setTheme('auto')">
                            <span class="text-gray-700 dark:text-gray-300">üîÑ Auto (System)</span>
                        </label>
                    </div>
                </div>

                <!-- Game Settings -->
                <div class="space-y-4">
                    <h4 class="font-medium text-gray-700 dark:text-gray-300">üéÆ Game Options</h4>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between">
                            <span class="text-gray-700 dark:text-gray-300">‚ö° Auto-focus Input</span>
                            <input type="checkbox" id="autoFocusToggle" class="rounded" checked
                                onchange="toggleAutoFocus()">
                        </label>
                    </div>
                </div>

                <!-- Speed Mode Settings -->
                <div class="space-y-4">
                    <h4 class="font-medium text-gray-700 dark:text-gray-300">‚è±Ô∏è Speed Mode Timer</h4>
                    <div class="space-y-2">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="radio" name="timer" value="20" class="text-blue-600" onchange="setTimer(20)">
                            <span class="text-gray-700 dark:text-gray-300">20 seconds</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="radio" name="timer" value="30" class="text-blue-600" onchange="setTimer(30)"
                                checked>
                            <span class="text-gray-700 dark:text-gray-300">30 seconds</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="radio" name="timer" value="60" class="text-blue-600" onchange="setTimer(60)">
                            <span class="text-gray-700 dark:text-gray-300">60 seconds</span>
                        </label>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="space-y-4">
                    <h4 class="font-medium text-gray-700 dark:text-gray-300">üíæ Data</h4>
                    <div class="space-y-2">
                        <button onclick="resetHighScore()"
                            class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg transition-colors duration-200">
                            üóëÔ∏è Reset High Score
                        </button>
                        <button onclick="exportStats()"
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition-colors duration-200">
                            üìä Export Stats
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Stats -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6 border dark:border-gray-700">
            <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="currentScore">0</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Current Score</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="streak">0</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Streak</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="highScore">0</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">High Score</div>
                </div>
            </div>
        </div>

        <!-- Game Area -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 mb-6 border dark:border-gray-700">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="text-center">
                <div class="text-6xl mb-4">üéØ</div>
                <h2 class="text-2xl font-semibold text-gray-800 dark:text-white mb-4">Choose Your Mode</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-6">All problems require carry-over or borrowing - perfect
                    for mental math practice!</p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-red-50 dark:bg-red-900/30 border-2 border-red-200 dark:border-red-700 rounded-lg p-4 hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors cursor-pointer"
                        onclick="startGame('speed')">
                        <div class="text-3xl mb-2">‚ö°</div>
                        <h3 class="font-semibold text-red-700 dark:text-red-300 mb-2">Speed Mode</h3>
                        <p class="text-sm text-red-600 dark:text-red-400">20-60 seconds<br>Beat the clock!</p>
                    </div>

                    <div class="bg-blue-50 dark:bg-blue-900/30 border-2 border-blue-200 dark:border-blue-700 rounded-lg p-4 hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors cursor-pointer"
                        onclick="startGame('classic')">
                        <div class="text-3xl mb-2">üéØ</div>
                        <h3 class="font-semibold text-blue-700 dark:text-blue-300 mb-2">Classic Mode</h3>
                        <p class="text-sm text-blue-600 dark:text-blue-400">10 questions<br>No time pressure</p>
                    </div>

                    <div class="bg-green-50 dark:bg-green-900/30 border-2 border-green-200 dark:border-green-700 rounded-lg p-4 hover:bg-green-100 dark:hover:bg-green-900/50 transition-colors cursor-pointer"
                        onclick="showTrainingModes()">
                        <div class="text-3xl mb-2">üìö</div>
                        <h3 class="font-semibold text-green-700 dark:text-green-300 mb-2">Training Mode</h3>
                        <p class="text-sm text-green-600 dark:text-green-400">Practice specific<br>operations!</p>
                    </div>
                </div>
            </div>

            <!-- Training Mode Selection -->
            <div id="trainingScreen" class="hidden text-center">
                <div class="text-6xl mb-6">üìö</div>
                <h2 class="text-2xl font-semibold text-gray-800 dark:text-white mb-6">Choose Training Mode</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-8">Practice specific operations or mix them all together!
                </p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-blue-50 dark:bg-blue-900/30 border-2 border-blue-200 dark:border-blue-700 rounded-lg p-4 hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors cursor-pointer"
                        onclick="startGame('addition')">
                        <div class="text-3xl mb-2">‚ûï</div>
                        <h3 class="font-semibold text-blue-700 dark:text-blue-300 mb-2">Addition Only</h3>
                        <p class="text-sm text-blue-600 dark:text-blue-400">Practice carry-over addition</p>
                    </div>

                    <div class="bg-red-50 dark:bg-red-900/30 border-2 border-red-200 dark:border-red-700 rounded-lg p-4 hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors cursor-pointer"
                        onclick="startGame('subtraction')">
                        <div class="text-3xl mb-2">‚ûñ</div>
                        <h3 class="font-semibold text-red-700 dark:text-red-300 mb-2">Subtraction Only</h3>
                        <p class="text-sm text-red-600 dark:text-red-400">Practice borrowing subtraction</p>
                    </div>

                    <div class="bg-purple-50 dark:bg-purple-900/30 border-2 border-purple-200 dark:border-purple-700 rounded-lg p-4 hover:bg-purple-100 dark:hover:bg-purple-900/50 transition-colors cursor-pointer"
                        onclick="startGame('multiplication')">
                        <div class="text-3xl mb-2">‚úñÔ∏è</div>
                        <h3 class="font-semibold text-purple-700 dark:text-purple-300 mb-2">Multiplication Only</h3>
                        <p class="text-sm text-purple-600 dark:text-purple-400">Practice multi-digit multiplication</p>
                    </div>

                    <div class="bg-orange-50 dark:bg-orange-900/30 border-2 border-orange-200 dark:border-orange-700 rounded-lg p-4 hover:bg-orange-100 dark:hover:bg-orange-900/50 transition-colors cursor-pointer"
                        onclick="startGame('division')">
                        <div class="text-3xl mb-2">‚ûó</div>
                        <h3 class="font-semibold text-orange-700 dark:text-orange-300 mb-2">Division Only</h3>
                        <p class="text-sm text-orange-600 dark:text-orange-400">Practice clean division</p>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/30 dark:to-blue-900/30 border-2 border-green-200 dark:border-green-700 rounded-lg p-6 hover:from-green-100 hover:to-blue-100 dark:hover:from-green-900/50 dark:hover:to-blue-900/50 transition-colors cursor-pointer"
                    onclick="startGame('infinite')">
                    <div class="text-4xl mb-3">‚ôæÔ∏è</div>
                    <h3 class="font-semibold text-green-700 dark:text-green-300 mb-3">Mixed Practice</h3>
                    <p class="text-sm text-green-600 dark:text-green-400">All operations mixed together - the ultimate
                        challenge!</p>
                </div>

                <div class="mt-8 grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <button onclick="backToMainMenu()"
                        class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg transition-colors duration-200">
                        ‚Üê Back to Main Menu
                    </button>
                </div>
            </div>

            <!-- Game Screen -->
            <div id="gameScreen" class="hidden text-center">
                <div id="timerDisplay" class="hidden mb-4">
                    <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="timeLeft">30</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">seconds left</div>
                </div>

                <div class="mb-6">
                    <div class="text-4xl font-bold text-gray-800 dark:text-white mb-4" id="question">10 + 5 = ?</div>
                    <input type="number" id="answerInput"
                        class="text-2xl text-center border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg py-3 px-4 w-48 focus:border-blue-500 dark:focus:border-blue-400 focus:outline-none"
                        placeholder="Your answer" step="0.01">
                </div>

                <div class="space-x-4 mb-6">
                    <button onclick="submitAnswer()" id="submitBtn"
                        class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200">
                        Submit Answer
                    </button>
                    <button onclick="skipQuestion()"
                        class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200">
                        Skip
                    </button>
                    <button onclick="endGame()" id="quitBtn"
                        class="hidden bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200">
                        Quit Game
                    </button>
                </div>

                <div id="feedback" class="text-lg font-medium h-6"></div>
            </div>

            <!-- Game Over Screen -->
            <div id="gameOverScreen" class="hidden text-center">
                <div class="text-6xl mb-4">üèÜ</div>
                <h2 class="text-2xl font-semibold text-gray-800 dark:text-white mb-4">Game Complete!</h2>
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 mb-6">
                    <div class="text-3xl font-bold text-blue-600 dark:text-blue-400 mb-2" id="finalScore">0</div>
                    <div class="text-gray-600 dark:text-gray-300 mb-4">Final Score</div>
                    <div class="text-lg text-gray-700 dark:text-gray-300" id="gameStats"></div>
                </div>
                <div class="space-x-4">
                    <button onclick="startGame()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200">
                        Play Again
                    </button>
                    <button onclick="resetGame()"
                        class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200">
                        Main Menu
                    </button>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">How to Play</h3>
            <ul class="text-gray-600 dark:text-gray-300 space-y-2">
                <li>‚Ä¢ <strong>Speed Mode:</strong> 20-60 seconds to solve as many mixed problems as possible</li>
                <li>‚Ä¢ <strong>Classic Mode:</strong> 10 mixed questions with no time pressure</li>
                <li>‚Ä¢ <strong>Training Mode:</strong> Practice specific operations or mix them all</li>
                <li>‚Ä¢ Addition/Subtraction: Problems requiring carry-over or borrowing</li>
                <li>‚Ä¢ Multiplication: Two-digit √ó single-digit (like 47 √ó 6)</li>
                <li>‚Ä¢ Division: Always results in whole numbers (like 168 √∑ 7)</li>
            </ul>
        </div>
    </div>

    <script>
        let currentScore = 0;
        let streak = 0;
        let highScore = localStorage.getItem('calcGameHighScore') || 0;
        let currentQuestion = {};
        let questionsAnswered = 0;
        let correctAnswers = 0;
        let gameActive = false;
        let gameMode = 'classic';
        let timeLeft = 30;
        let timer = null;

        // Settings
        let settings = {
            theme: localStorage.getItem('calcGameTheme') || 'light',
            soundEnabled: localStorage.getItem('calcGameSound') === 'true',
            autoFocus: localStorage.getItem('calcGameAutoFocus') !== 'false',
            hintsEnabled: localStorage.getItem('calcGameHints') === 'true',
            speedTimer: parseInt(localStorage.getItem('calcGameSpeedTimer')) || 30
        };

        // Initialize theme and settings on load
        initializeSettings();
        document.getElementById('highScore').textContent = highScore;

        function initializeSettings() {
            // Apply theme
            applyTheme(settings.theme);

            // Set form values
            document.querySelector(`input[name="theme"][value="${settings.theme}"]`).checked = true;
            document.getElementById('soundToggle').checked = settings.soundEnabled;
            document.getElementById('autoFocusToggle').checked = settings.autoFocus;
            document.getElementById('hintsToggle').checked = settings.hintsEnabled;
            document.querySelector(`input[name="timer"][value="${settings.speedTimer}"]`).checked = true;
        }

        function applyTheme(theme) {
            const html = document.documentElement;

            if (theme === 'dark') {
                html.classList.add('dark');
            } else if (theme === 'light') {
                html.classList.remove('dark');
            } else if (theme === 'auto') {
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }
            }
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
        }

        function setTheme(theme) {
            settings.theme = theme;
            localStorage.setItem('calcGameTheme', theme);
            applyTheme(theme);
        }

        function toggleSound() {
            settings.soundEnabled = document.getElementById('soundToggle').checked;
            localStorage.setItem('calcGameSound', settings.soundEnabled);
        }

        function toggleAutoFocus() {
            settings.autoFocus = document.getElementById('autoFocusToggle').checked;
            localStorage.setItem('calcGameAutoFocus', settings.autoFocus);
        }

        function toggleHints() {
            settings.hintsEnabled = document.getElementById('hintsToggle').checked;
            localStorage.setItem('calcGameHints', settings.hintsEnabled);
        }

        function setTimer(seconds) {
            settings.speedTimer = seconds;
            localStorage.setItem('calcGameSpeedTimer', seconds);
        }

        function resetHighScore() {
            if (confirm('Are you sure you want to reset your high score? This cannot be undone.')) {
                highScore = 0;
                localStorage.removeItem('calcGameHighScore');
                document.getElementById('highScore').textContent = highScore;
                alert('High score has been reset!');
            }
        }

        function exportStats() {
            const stats = {
                highScore: highScore,
                currentScore: currentScore,
                streak: streak,
                settings: settings,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(stats, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'calculation-game-stats.json';
            link.click();
        }

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (settings.theme === 'auto') {
                applyTheme('auto');
            }
        });

        function generateQuestion() {
            let operations;

            // Determine which operations to use based on game mode
            if (gameMode === 'addition') {
                operations = ['+'];
            } else if (gameMode === 'subtraction') {
                operations = ['-'];
            } else if (gameMode === 'multiplication') {
                operations = ['*'];
            } else if (gameMode === 'division') {
                operations = ['/'];
            } else {
                // For speed, classic, and infinite modes - use all operations
                operations = ['+', '-', '*', '/'];
            }

            const operation = operations[Math.floor(Math.random() * operations.length)];

            let num1, num2;

            if (operation === '+') {
                // Addition that requires carry-over
                // Generate numbers where at least one digit position requires carrying
                do {
                    num1 = Math.floor(Math.random() * 89) + 10; // 10-98
                    num2 = Math.floor(Math.random() * 89) + 10; // 10-98
                } while (!requiresCarryOver(num1, num2, '+'));

            } else if (operation === '-') {
                // Subtraction that requires borrowing
                do {
                    num1 = Math.floor(Math.random() * 89) + 20; // 20-108 (larger first number)
                    num2 = Math.floor(Math.random() * 79) + 10; // 10-88
                } while (!requiresCarryOver(num1, num2, '-') || num1 <= num2);

            } else if (operation === '*') {
                // Multiplication: two-digit √ó one-digit (requires carrying)
                num1 = Math.floor(Math.random() * 90) + 10; // 10-99
                num2 = Math.floor(Math.random() * 8) + 2; // 2-9

            } else if (operation === '/') {
                // Division: ensure clean division with two-digit results
                num2 = Math.floor(Math.random() * 8) + 2; // 2-9
                let quotient = Math.floor(Math.random() * 90) + 10; // 10-99
                num1 = num2 * quotient; // This ensures clean division
            }

            let correctAnswer;
            switch (operation) {
                case '+':
                    correctAnswer = num1 + num2;
                    break;
                case '-':
                    correctAnswer = num1 - num2;
                    break;
                case '*':
                    correctAnswer = num1 * num2;
                    break;
                case '/':
                    correctAnswer = num1 / num2;
                    break;
            }

            return {
                num1: num1,
                num2: num2,
                operation: operation,
                correctAnswer: correctAnswer,
                questionText: `${num1} ${operation} ${num2} = ?`
            };
        }

        function requiresCarryOver(num1, num2, operation) {
            if (operation === '+') {
                // Check if any digit position requires carrying
                let ones1 = num1 % 10;
                let ones2 = num2 % 10;
                let tens1 = Math.floor(num1 / 10) % 10;
                let tens2 = Math.floor(num2 / 10) % 10;

                return (ones1 + ones2 >= 10) || (tens1 + tens2 >= 10);
            } else if (operation === '-') {
                // Check if any digit position requires borrowing
                let ones1 = num1 % 10;
                let ones2 = num2 % 10;
                let tens1 = Math.floor(num1 / 10) % 10;
                let tens2 = Math.floor(num2 / 10) % 10;

                return (ones1 < ones2) || (tens1 < tens2);
            }
            return false;
        }

        function startGame(mode = 'classic') {
            gameActive = true;
            gameMode = mode;
            questionsAnswered = 0;
            correctAnswers = 0;

            // Clear any existing timer
            if (timer) {
                clearInterval(timer);
                timer = null;
            }

            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');

            // Setup timer for speed mode
            if (gameMode === 'speed') {
                timeLeft = settings.speedTimer;
                document.getElementById('timerDisplay').classList.remove('hidden');
                document.getElementById('timeLeft').textContent = timeLeft;
                startTimer();
            } else {
                document.getElementById('timerDisplay').classList.add('hidden');
            }

            // Show quit button for all modes
            document.getElementById('quitBtn').classList.remove('hidden');

            nextQuestion();
            if (settings.autoFocus) {
                document.getElementById('answerInput').focus();
            }
        }

        function startTimer() {
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timeLeft').textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    endGame();
                }
            }, 1000);
        }

        function nextQuestion() {
            if (!gameActive) return;

            currentQuestion = generateQuestion();
            document.getElementById('question').textContent = currentQuestion.questionText;
            document.getElementById('answerInput').value = '';
            document.getElementById('feedback').textContent = '';
            if (settings.autoFocus) {
                document.getElementById('answerInput').focus();
            }

            // Add fade-in animation
            document.getElementById('question').classList.add('fade-in');
            setTimeout(() => {
                document.getElementById('question').classList.remove('fade-in');
            }, 500);
        }

        function submitAnswer() {
            if (!gameActive) return;

            const userAnswer = parseFloat(document.getElementById('answerInput').value);
            const submitBtn = document.getElementById('submitBtn');

            if (isNaN(userAnswer)) {
                showFeedback('Please enter a valid number!', 'text-red-600');
                return;
            }

            questionsAnswered++;

            // Check if answer is correct (allow small margin for floating point)
            const isCorrect = Math.abs(userAnswer - currentQuestion.correctAnswer) < 0.01;

            if (isCorrect) {
                correctAnswers++;
                currentScore++;
                streak++;

                // Update displays
                document.getElementById('currentScore').textContent = currentScore;
                document.getElementById('streak').textContent = streak;

                // Check for new high score
                if (currentScore > highScore) {
                    highScore = currentScore;
                    document.getElementById('highScore').textContent = highScore;
                    localStorage.setItem('calcGameHighScore', highScore);
                }

                showFeedback('Correct! üéâ', 'text-green-600');
                submitBtn.classList.add('pulse-correct');

                setTimeout(() => {
                    submitBtn.classList.remove('pulse-correct');
                    nextQuestion();
                }, 1000);

            } else {
                streak = 0;
                document.getElementById('streak').textContent = streak;

                const correctAnswer = currentQuestion.correctAnswer % 1 === 0 ?
                    currentQuestion.correctAnswer :
                    currentQuestion.correctAnswer.toFixed(2);

                showFeedback(`Incorrect. The answer was ${correctAnswer}`, 'text-red-600');
                submitBtn.classList.add('pulse-incorrect');

                setTimeout(() => {
                    submitBtn.classList.remove('pulse-incorrect');
                    nextQuestion();
                }, 1500);
            }

            // End game conditions based on mode
            if (gameMode === 'classic' && questionsAnswered >= 10) {
                setTimeout(() => {
                    endGame();
                }, isCorrect ? 1000 : 1500);
            } else if (gameMode === 'infinite') {
                // Continue indefinitely - no end condition
            }
        }

        function skipQuestion() {
            if (!gameActive) return;

            questionsAnswered++;
            streak = 0;
            document.getElementById('streak').textContent = streak;

            showFeedback('Question skipped', 'text-yellow-600');

            if (gameMode === 'classic' && questionsAnswered >= 10) {
                setTimeout(() => {
                    endGame();
                }, 1000);
            } else {
                setTimeout(() => {
                    nextQuestion();
                }, 1000);
            }
        }

        function endGame() {
            gameActive = false;

            // Clear timer if running
            if (timer) {
                clearInterval(timer);
                timer = null;
            }

            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.remove('hidden');

            document.getElementById('finalScore').textContent = currentScore;

            const accuracy = questionsAnswered > 0 ? Math.round((correctAnswers / questionsAnswered) * 100) : 0;
            let modeText = '';
            if (gameMode === 'speed') modeText = 'Speed Mode - ';
            else if (gameMode === 'infinite') modeText = 'Infinite Mode - ';
            else modeText = 'Classic Mode - ';

            document.getElementById('gameStats').innerHTML = `
                ${modeText}You answered ${correctAnswers} out of ${questionsAnswered} questions correctly<br>
                Accuracy: ${accuracy}%
            `;
        }

        function resetGame() {
            currentScore = 0;
            streak = 0;
            questionsAnswered = 0;
            correctAnswers = 0;
            gameActive = false;

            document.getElementById('currentScore').textContent = currentScore;
            document.getElementById('streak').textContent = streak;

            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('trainingScreen').classList.add('hidden');
            document.getElementById('welcomeScreen').classList.remove('hidden');
        }

        function showTrainingModes() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('trainingScreen').classList.remove('hidden');
        }

        function backToMainMenu() {
            document.getElementById('trainingScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('welcomeScreen').classList.remove('hidden');
        }

        function showFeedback(message, className) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = `text-lg font-medium h-6 ${className}`;
        }

        // Allow Enter key to submit answer
        document.getElementById('answerInput').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form submission
                if (gameActive) {
                    submitAnswer();
                }
            }
        });
    </script>
    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'97095206a77e3e68',t:'MTc1NTQzNTI3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>
